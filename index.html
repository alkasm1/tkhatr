<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NeuroSound â€” Ø§Ù„ØµÙˆØª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=Oxanium:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root {
      --bg-deep: #060b18;
      --bg-primary: #0b1120;
      --bg-card: #111d35;
      --bg-card-alt: #162244;
      --bg-input: #0d1629;
      --accent-main: #6ee7b7;
      --accent-blue: #38bdf8;
      --accent-violet: #a78bfa;
      --accent-rose: #fb7185;
      --accent-amber: #fbbf24;
      --accent-teal: #2dd4bf;
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --text-muted: #475569;
      --border: rgba(110, 231, 183, 0.12);
      --glow-main: 0 0 30px rgba(110, 231, 183, 0.15);
      --glow-blue: 0 0 25px rgba(56, 189, 248, 0.15);
      --radius: 18px;
      --radius-sm: 12px;
      --radius-xs: 8px;
    }

    html:not(.dark) {
      --bg-deep: #f1f5f9;
      --bg-primary: #f8fafc;
      --bg-card: #ffffff;
      --bg-card-alt: #f1f5f9;
      --bg-input: #e2e8f0;
      --accent-main: #059669;
      --accent-blue: #0284c7;
      --accent-violet: #7c3aed;
      --accent-rose: #e11d48;
      --accent-amber: #d97706;
      --accent-teal: #0d9488;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --border: rgba(5, 150, 105, 0.15);
      --glow-main: 0 0 20px rgba(5, 150, 105, 0.08);
      --glow-blue: 0 0 15px rgba(2, 132, 199, 0.08);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Tajawal', sans-serif;
      background: var(--bg-deep);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Atmospheric background */
    .atmosphere {
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
    }
    .atmosphere::before {
      content: '';
      position: absolute;
      width: 600px; height: 600px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(110,231,183,0.06) 0%, transparent 70%);
      top: -200px; left: 50%; transform: translateX(-50%);
      animation: breathe 8s ease-in-out infinite;
    }
    .atmosphere::after {
      content: '';
      position: absolute;
      width: 500px; height: 500px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(167,139,250,0.04) 0%, transparent 70%);
      bottom: -150px; right: -100px;
      animation: breathe 10s ease-in-out infinite reverse;
    }
    @keyframes breathe {
      0%, 100% { transform: translateX(-50%) scale(1); opacity: 0.8; }
      50% { transform: translateX(-50%) scale(1.15); opacity: 1; }
    }

    .app {
      position: relative; z-index: 1;
      max-width: 820px;
      margin: 0 auto;
      padding: 16px 14px 50px;
    }

    /* Header */
    .header {
      text-align: center;
      padding: 28px 0 10px;
    }
    .neuro-orb {
      width: 80px; height: 80px;
      margin: 0 auto 14px;
      position: relative;
      display: flex; align-items: center; justify-content: center;
    }
    .neuro-orb .ring {
      position: absolute;
      border-radius: 50%;
      border: 1.5px solid;
      animation: orbSpin 6s linear infinite;
    }
    .neuro-orb .ring-1 { width: 80px; height: 80px; border-color: rgba(110,231,183,0.25); }
    .neuro-orb .ring-2 { width: 60px; height: 60px; border-color: rgba(167,139,250,0.2); animation-direction: reverse; animation-duration: 8s; }
    .neuro-orb .ring-3 { width: 42px; height: 42px; border-color: rgba(56,189,248,0.15); animation-duration: 10s; }
    @keyframes orbSpin { to { transform: rotate(360deg); } }
    .neuro-orb .core {
      width: 18px; height: 18px; border-radius: 50%;
      background: radial-gradient(circle, var(--accent-main), transparent);
      animation: corePulse 3s ease-in-out infinite;
    }
    @keyframes corePulse {
      0%, 100% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.3); opacity: 1; }
    }

    .header h1 {
      font-family: 'Oxanium', sans-serif;
      font-size: 26px; font-weight: 800;
      background: linear-gradient(135deg, var(--accent-main), var(--accent-blue), var(--accent-violet));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 3px;
      margin-bottom: 6px;
    }
    .header .tagline {
      color: var(--text-secondary);
      font-size: 14px; font-weight: 300; line-height: 1.7;
    }

    /* Section cards */
    .section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 22px;
      margin-bottom: 14px;
      animation: cardIn 0.4s ease both;
    }
    @keyframes cardIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .sec-head {
      display: flex; align-items: center; gap: 10px;
      margin-bottom: 16px;
    }
    .sec-icon {
      width: 36px; height: 36px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; flex-shrink: 0;
    }
    .sec-title { font-size: 16px; font-weight: 700; }
    .sec-desc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

    /* Upload */
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: var(--radius-sm);
      padding: 36px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }
    .upload-area:hover, .upload-area.hovering { border-color: var(--accent-main); background: rgba(110,231,183,0.03); }
    .upload-area.loaded { border-style: solid; border-color: var(--accent-main); padding: 16px; }
    .upload-area input { display: none; }
    .upload-ph i { font-size: 36px; color: var(--accent-main); opacity: 0.5; margin-bottom: 10px; }
    .upload-ph p { font-size: 14px; color: var(--text-secondary); }
    .upload-ph small { font-size: 12px; color: var(--text-muted); }

    .file-row {
      display: flex; align-items: center; gap: 12px;
    }
    .file-row .f-icon {
      width: 44px; height: 44px; border-radius: 12px;
      background: rgba(110,231,183,0.1);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .file-row .f-icon i { font-size: 20px; color: var(--accent-main); }
    .file-row .f-info { flex: 1; }
    .file-row .f-name { font-size: 14px; font-weight: 600; word-break: break-all; }
    .file-row .f-meta { font-size: 11px; color: var(--text-muted); }
    .btn-x {
      width: 32px; height: 32px; border-radius: 50%;
      border: none; background: rgba(251,113,133,0.1); color: var(--accent-rose);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: 0.2s; flex-shrink: 0; font-size: 14px;
    }
    .btn-x:hover { background: rgba(251,113,133,0.2); transform: scale(1.1); }

    /* Mode selector */
    .modes-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .mode-card {
      padding: 16px 14px;
      border-radius: var(--radius-sm);
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.3s;
      background: var(--bg-card-alt);
      text-align: center;
    }
    .mode-card:hover { border-color: var(--border); }
    .mode-card.active { border-color: var(--mode-color); background: var(--mode-bg); box-shadow: 0 0 25px var(--mode-glow); }
    .mode-card[data-mode="inner"]    { --mode-color: #6ee7b7; --mode-bg: rgba(110,231,183,0.06); --mode-glow: rgba(110,231,183,0.1); }
    .mode-card[data-mode="subliminal"] { --mode-color: #a78bfa; --mode-bg: rgba(167,139,250,0.06); --mode-glow: rgba(167,139,250,0.1); }
    .mode-card[data-mode="meditate"]  { --mode-color: #38bdf8; --mode-bg: rgba(56,189,248,0.06); --mode-glow: rgba(56,189,248,0.1); }
    .mode-card[data-mode="focus"]     { --mode-color: #fbbf24; --mode-bg: rgba(251,191,36,0.06); --mode-glow: rgba(251,191,36,0.1); }

    .mode-emoji { font-size: 28px; margin-bottom: 6px; }
    .mode-name { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
    .mode-desc { font-size: 11px; color: var(--text-muted); line-height: 1.5; }

    /* Sliders */
    .ctrl-group { margin-bottom: 16px; }
    .ctrl-row {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 6px;
    }
    .ctrl-label { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
    .ctrl-val {
      font-family: 'Oxanium', sans-serif;
      font-size: 13px; font-weight: 700; color: var(--accent-main);
      min-width: 50px; text-align: left;
    }

    input[type="range"] {
      -webkit-appearance: none; width: 100%; height: 5px;
      background: rgba(110,231,183,0.1); border-radius: 3px; outline: none; cursor: pointer;
    }
    html:not(.dark) input[type="range"] { background: rgba(5,150,105,0.1); }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 20px; height: 20px;
      border-radius: 50%; background: var(--accent-main);
      box-shadow: var(--glow-main); cursor: pointer; transition: transform 0.2s;
    }
    input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.15); }
    input[type="range"]::-moz-range-thumb {
      width: 20px; height: 20px; border-radius: 50%;
      background: var(--accent-main); box-shadow: var(--glow-main); border: none; cursor: pointer;
    }

    /* Toggles */
    .tog-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .tog-row:last-child { border-bottom: none; }
    .tog-text .tog-title { font-size: 13px; font-weight: 600; }
    .tog-text .tog-desc { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .tog {
      position: relative; width: 46px; height: 26px; flex-shrink: 0;
    }
    .tog input { opacity: 0; width: 0; height: 0; }
    .tog-track {
      position: absolute; inset: 0;
      background: rgba(255,255,255,0.08); border-radius: 13px;
      cursor: pointer; transition: 0.3s;
    }
    html:not(.dark) .tog-track { background: rgba(0,0,0,0.1); }
    .tog-track::before {
      content: ''; position: absolute;
      height: 20px; width: 20px;
      right: 3px; bottom: 3px;
      background: #fff; border-radius: 50%;
      transition: 0.3s;
    }
    .tog input:checked + .tog-track { background: var(--accent-main); }
    .tog input:checked + .tog-track::before { transform: translateX(-20px); }

    /* Visualizer */
    .viz-box {
      width: 100%; height: 130px;
      border-radius: var(--radius-sm);
      background: rgba(0,0,0,0.25);
      position: relative; overflow: hidden;
      margin-bottom: 14px;
    }
    html:not(.dark) .viz-box { background: rgba(0,0,0,0.04); }
    .viz-box canvas { width: 100%; height: 100%; display: block; }
    .viz-tag {
      position: absolute; top: 8px; right: 10px;
      font-family: 'Oxanium', sans-serif;
      font-size: 9px; color: var(--text-muted);
      letter-spacing: 1.5px; text-transform: uppercase;
    }
    .viz-mode-tag {
      position: absolute; bottom: 8px; left: 10px;
      font-family: 'Oxanium', sans-serif;
      font-size: 9px; letter-spacing: 1px;
      color: var(--accent-main); opacity: 0.7;
    }

    /* Transport */
    .transport { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
    .btn-round {
      width: 50px; height: 50px; border-radius: 50%;
      border: 2px solid var(--accent-main); background: transparent;
      color: var(--accent-main); font-size: 18px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.3s; flex-shrink: 0;
    }
    .btn-round:hover { background: rgba(110,231,183,0.08); box-shadow: var(--glow-main); }
    .btn-round.on { background: var(--accent-main); color: var(--bg-primary); }
    .btn-round.sm { width: 38px; height: 38px; font-size: 14px; }
    .btn-round:disabled { opacity: 0.25; cursor: not-allowed; }

    .prog-wrap { flex: 1; }
    .prog-bg {
      width: 100%; height: 5px;
      background: rgba(110,231,183,0.08); border-radius: 3px;
      cursor: pointer; overflow: hidden; margin-bottom: 5px;
    }
    .prog-fill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--accent-main), var(--accent-blue));
      border-radius: 3px; transition: width 0.1s linear;
    }
    .prog-times {
      display: flex; justify-content: space-between;
      font-family: 'Oxanium', sans-serif; font-size: 11px; color: var(--text-muted);
    }

    .vol-row {
      display: flex; align-items: center; gap: 8px; margin-bottom: 16px;
    }
    .vol-row i { color: var(--text-muted); font-size: 14px; }
    .vol-row input { flex: 1; }
    .vol-row .ctrl-val { min-width: 36px; }

    /* Buttons */
    .btn-main {
      width: 100%; padding: 15px; border: none;
      border-radius: var(--radius-sm);
      font-family: 'Tajawal', sans-serif;
      font-size: 16px; font-weight: 700;
      cursor: pointer; transition: all 0.3s;
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn-process {
      background: linear-gradient(135deg, var(--accent-main), var(--accent-teal));
      color: #0b1120;
    }
    html:not(.dark) .btn-process { color: #fff; }
    .btn-process:hover { box-shadow: 0 6px 30px rgba(110,231,183,0.25); transform: translateY(-1px); }
    .btn-process:disabled { opacity: 0.3; cursor: not-allowed; transform: none; box-shadow: none; }

    .btn-dl {
      background: rgba(56,189,248,0.08); color: var(--accent-blue);
      border: 1px solid rgba(56,189,248,0.2); margin-top: 10px;
    }
    .btn-dl:hover { background: rgba(56,189,248,0.14); }
    .btn-dl:disabled { opacity: 0.25; cursor: not-allowed; }

    /* Status */
    .status {
      display: none; align-items: center; gap: 8px;
      padding: 10px 14px; border-radius: var(--radius-xs);
      font-size: 13px; font-weight: 500; margin-bottom: 14px;
    }
    .status.on { display: flex; }
    .status.working { background: rgba(110,231,183,0.06); color: var(--accent-main); border: 1px solid rgba(110,231,183,0.12); }
    .status.done    { background: rgba(56,189,248,0.06); color: var(--accent-blue); border: 1px solid rgba(56,189,248,0.12); }
    .status.fail    { background: rgba(251,113,133,0.06); color: var(--accent-rose); border: 1px solid rgba(251,113,133,0.12); }
    .spin {
      width: 14px; height: 14px;
      border: 2px solid transparent; border-top-color: currentColor;
      border-radius: 50%; animation: sp 0.7s linear infinite;
    }
    @keyframes sp { to { transform: rotate(360deg); } }

    /* Info grid */
    .info-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;
    }
    .info-cell {
      padding: 12px;
      border-radius: var(--radius-xs);
      background: var(--bg-card-alt);
      border: 1px solid var(--border);
    }
    .info-cell .il { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .info-cell .iv { font-family: 'Oxanium', sans-serif; font-size: 15px; font-weight: 700; color: var(--accent-main); }

    /* Preset chips */
    .presets { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .preset-chip {
      padding: 7px 14px; border-radius: 20px;
      font-size: 12px; font-weight: 600;
      background: var(--bg-card-alt); border: 1px solid var(--border);
      cursor: pointer; transition: 0.2s; color: var(--text-secondary);
    }
    .preset-chip:hover { border-color: var(--accent-main); color: var(--accent-main); }
    .preset-chip.active { background: rgba(110,231,183,0.1); border-color: var(--accent-main); color: var(--accent-main); }

    /* Explanation */
    .explain p { font-size: 13px; color: var(--text-secondary); line-height: 1.9; margin-bottom: 8px; }
    .explain strong { color: var(--accent-main); }
    .explain .highlight { color: var(--accent-violet); font-weight: 700; }
    .explain .note {
      padding: 12px 16px; border-radius: var(--radius-xs);
      background: rgba(56,189,248,0.05); border-right: 3px solid var(--accent-blue);
      margin-top: 10px; font-size: 12px; color: var(--text-secondary); line-height: 1.8;
    }
    html:not(.dark) .explain .note { border-right-color: var(--accent-blue); }

    .footer {
      text-align: center; padding: 20px; font-size: 11px;
      color: var(--text-muted); font-family: 'Oxanium', sans-serif; letter-spacing: 1px;
    }

    /* Responsive */
    @media (max-width: 500px) {
      .modes-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
      .mode-card { padding: 12px 10px; }
      .mode-emoji { font-size: 24px; }
      .header h1 { font-size: 22px; }
      .section { padding: 18px; }
    }
  </style>
</head>
<body>
<div class="atmosphere"></div>

<div class="app">
  <!-- Header -->
  <div class="header">
    <div class="neuro-orb">
      <div class="ring ring-1"></div>
      <div class="ring ring-2"></div>
      <div class="ring ring-3"></div>
      <div class="core"></div>
    </div>
    <h1>NEUROSOUND</h1>
    <p class="tagline">Ø­ÙˆÙ‘Ù„ Ø£ÙŠ ØµÙˆØª Ø¥Ù„Ù‰ ØªØ¬Ø±Ø¨Ø© Ø³Ù…Ø¹ÙŠØ© Ø¯Ø§Ø®Ù„ÙŠØ© â€” ÙƒØ£Ù†Ùƒ ØªØ³Ù…Ø¹ Ø¨Ø¹Ù‚Ù„Ùƒ</p>
  </div>

  <!-- 1. Upload -->
  <div class="section" style="animation-delay:0.05s">
    <div class="sec-head">
      <div class="sec-icon" style="background:rgba(110,231,183,0.1);color:var(--accent-main);">
        <i class="fas fa-file-audio"></i>
      </div>
      <div>
        <div class="sec-title">Ø±ÙØ¹ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„ØµÙˆØªÙŠ</div>
        <div class="sec-desc">MP3, WAV, OGG, M4A â€” Ø­ØªÙ‰ 50 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª</div>
      </div>
    </div>
    <div class="upload-area" id="uploadZone">
      <input type="file" id="audioInput" accept="audio/*">
      <div id="uploadPh">
        <div><i class="fas fa-cloud-arrow-up"></i></div>
        <p>Ø§Ø¶ØºØ· Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ù…Ù„ÙØ§Ù‹ ØµÙˆØªÙŠØ§Ù‹</p>
        <small>Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ ØµÙˆØª Ø¯Ø§Ø®Ù„ÙŠ ÙŠØ³ØªÙ‚Ø¨Ù„Ù‡ Ø§Ù„Ø¯Ù…Ø§Øº</small>
      </div>
      <div id="fileRow" style="display:none" class="file-row">
        <div class="f-icon"><i class="fas fa-music"></i></div>
        <div class="f-info">
          <div class="f-name" id="fName"></div>
          <div class="f-meta" id="fMeta"></div>
        </div>
        <button class="btn-x" id="btnRemove" type="button"><i class="fas fa-xmark"></i></button>
      </div>
    </div>
  </div>

  <!-- 2. Mode Selection -->
  <div class="section" style="animation-delay:0.1s">
    <div class="sec-head">
      <div class="sec-icon" style="background:rgba(167,139,250,0.1);color:var(--accent-violet);">
        <i class="fas fa-brain"></i>
      </div>
      <div>
        <div class="sec-title">ÙˆØ¶Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„</div>
        <div class="sec-desc">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙŠ ÙŠØ³ØªÙ‚Ø¨Ù„ Ø¨Ù‡Ø§ Ø¯Ù…Ø§ØºÙƒ Ø§Ù„ØµÙˆØª</div>
      </div>
    </div>
    <div class="modes-grid" id="modesGrid">
      <div class="mode-card active" data-mode="inner">
        <div class="mode-emoji">ğŸ§ </div>
        <div class="mode-name" style="color:var(--accent-main)">Ø§Ù„ØµÙˆØª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</div>
        <div class="mode-desc">ÙŠØ­ÙˆÙ„ Ø§Ù„ØµÙˆØª Ù„ÙŠØ¨Ø¯Ùˆ ÙƒØ£Ù†Ù‡ Ø­Ø¯ÙŠØ« Ù†ÙØ³Ùƒ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</div>
      </div>
      <div class="mode-card" data-mode="subliminal">
        <div class="mode-emoji">ğŸ‘ï¸</div>
        <div class="mode-name" style="color:var(--accent-violet)">ØªØ­Øª Ø§Ù„ÙˆØ¹ÙŠ</div>
        <div class="mode-desc">Ø±Ø³Ø§Ø¦Ù„ ØµÙˆØªÙŠØ© Ù„Ø§ÙˆØ§Ø¹ÙŠØ© ÙŠØ³ØªÙ‚Ø¨Ù„Ù‡Ø§ Ø§Ù„Ø¹Ù‚Ù„ Ø§Ù„Ø¨Ø§Ø·Ù†</div>
      </div>
      <div class="mode-card" data-mode="meditate">
        <div class="mode-emoji">ğŸŒŠ</div>
        <div class="mode-name" style="color:var(--accent-blue)">ØªØ£Ù…Ù„ Ø¹Ù…ÙŠÙ‚</div>
        <div class="mode-desc">Ø¯Ù…Ø¬ Ù…Ø¹ Ù…ÙˆØ¬Ø§Øª Ø«ÙŠØªØ§ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¹Ù‚Ù„ Ø§Ù„Ù„Ø§ÙˆØ§Ø¹ÙŠ</div>
      </div>
      <div class="mode-card" data-mode="focus">
        <div class="mode-emoji">âš¡</div>
        <div class="mode-name" style="color:var(--accent-amber)">ØªØ­ÙÙŠØ² Ø°Ù‡Ù†ÙŠ</div>
        <div class="mode-desc">ØªØ±Ø¯Ø¯Ø§Øª ØºØ§Ù…Ø§ Ù„ØªØ­ÙÙŠØ² Ø§Ù„Ø¥Ø¯Ø±Ø§Ùƒ ÙˆØ§Ù„ÙˆØ¹ÙŠ Ø§Ù„ÙØ§Ø¦Ù‚</div>
      </div>
    </div>

    <!-- Presets -->
    <div class="presets" id="presets">
      <div class="preset-chip active" data-preset="balanced">âš–ï¸ Ù…ØªÙˆØ§Ø²Ù†</div>
      <div class="preset-chip" data-preset="deep">ğŸŒ€ Ø¹Ù…ÙŠÙ‚ Ø¬Ø¯Ø§Ù‹</div>
      <div class="preset-chip" data-preset="gentle">ğŸƒ Ù„Ø·ÙŠÙ</div>
      <div class="preset-chip" data-preset="intense">ğŸ”¥ Ù…ÙƒØ«Ù‘Ù</div>
    </div>
  </div>

  <!-- 3. Controls -->
  <div class="section" style="animation-delay:0.15s">
    <div class="sec-head">
      <div class="sec-icon" style="background:rgba(56,189,248,0.1);color:var(--accent-blue);">
        <i class="fas fa-sliders"></i>
      </div>
      <div>
        <div class="sec-title">Ø¶Ø¨Ø· Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div>
        <div class="sec-desc">ØªØ­ÙƒÙ… Ø¯Ù‚ÙŠÙ‚ ÙÙŠ ÙƒÙŠÙÙŠØ© ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØª</div>
      </div>
    </div>

    <div class="ctrl-group">
      <div class="ctrl-row"><span class="ctrl-label">ØªØ±Ø¯Ø¯ Ø§Ù„ØªØ­ÙÙŠØ² Ø§Ù„Ø¹ØµØ¨ÙŠ</span><span class="ctrl-val" id="vFreq">10.0 Hz</span></div>
      <input type="range" id="sFreq" min="0.5" max="100" step="0.5" value="10">
    </div>
    <div class="ctrl-group">
      <div class="ctrl-row"><span class="ctrl-label">Ø¹Ù…Ù‚ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</span><span class="ctrl-val" id="vDepth">75%</span></div>
      <input type="range" id="sDepth" min="0" max="100" step="1" value="75">
    </div>
    <div class="ctrl-group">
      <div class="ctrl-row"><span class="ctrl-label">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‡Ù…Ø³ (Whisper)</span><span class="ctrl-val" id="vWhisper">60%</span></div>
      <input type="range" id="sWhisper" min="0" max="100" step="1" value="60">
    </div>
    <div class="ctrl-group">
      <div class="ctrl-row"><span class="ctrl-label">Ø±Ù†ÙŠÙ† Ø§Ù„Ø¬Ù…Ø¬Ù…Ø© (Resonance)</span><span class="ctrl-val" id="vResonance">50%</span></div>
      <input type="range" id="sResonance" min="0" max="100" step="1" value="50">
    </div>
    <div class="ctrl-group">
      <div class="ctrl-row"><span class="ctrl-label">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª ØªØ­Øª Ø§Ù„ÙˆØ¹ÙŠ</span><span class="ctrl-val" id="vSublevel">40%</span></div>
      <input type="range" id="sSublevel" min="5" max="100" step="1" value="40">
    </div>

    <div class="tog-row">
      <div class="tog-text">
        <div class="tog-title">Ù†ØºÙ…Ø§Øª Ø«Ù†Ø§Ø¦ÙŠØ© Ø§Ù„Ø£Ø°Ù† (Binaural)</div>
        <div class="tog-desc">ÙŠØ®Ù„Ù‚ ØµÙˆØªØ§Ù‹ ÙˆÙ‡Ù…ÙŠØ§Ù‹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ù…Ø§Øº â€” ÙŠØªØ·Ù„Ø¨ Ø³Ù…Ø§Ø¹Ø§Øª</div>
      </div>
      <label class="tog"><input type="checkbox" id="tBinaural" checked><span class="tog-track"></span></label>
    </div>
    <div class="tog-row">
      <div class="tog-text">
        <div class="tog-title">ØªØ£Ø«ÙŠØ± Ø§Ù„Ù‡Ù…Ø³ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</div>
        <div class="tog-desc">ÙŠØ­ÙˆÙ„ Ø§Ù„ØµÙˆØª Ù„Ù‡Ù…Ø³Ø© Ø¯Ø§Ø®Ù„ÙŠØ© ÙƒØ­Ø¯ÙŠØ« Ø§Ù„Ù†ÙØ³</div>
      </div>
      <label class="tog"><input type="checkbox" id="tWhisper" checked><span class="tog-track"></span></label>
    </div>
    <div class="tog-row">
      <div class="tog-text">
        <div class="tog-title">Ù…Ø­Ø§ÙƒØ§Ø© Ø±Ù†ÙŠÙ† Ø§Ù„Ø¬Ù…Ø¬Ù…Ø©</div>
        <div class="tog-desc">ÙŠØ¶ÙŠÙ Ø±Ù†ÙŠÙ† Ø·Ø¨ÙŠØ¹ÙŠ ÙŠØ´Ø¨Ù‡ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø¹Ø¸Ù…ÙŠ</div>
      </div>
      <label class="tog"><input type="checkbox" id="tResonance" checked><span class="tog-track"></span></label>
    </div>
    <div class="tog-row">
      <div class="tog-text">
        <div class="tog-title">Ø¶ØºØ· Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ</div>
        <div class="tog-desc">ÙŠØ¬Ø¹Ù„ Ø§Ù„ØµÙˆØª Ù…ØªØ³Ø§ÙˆÙŠØ§Ù‹ ÙƒØ§Ù„ØµÙˆØª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ</div>
      </div>
      <label class="tog"><input type="checkbox" id="tCompress" checked><span class="tog-track"></span></label>
    </div>
    <div class="tog-row">
      <div class="tog-text">
        <div class="tog-title">Ù…Ø²Ø¬ Ù…Ø±ÙƒØ²ÙŠ (Crossfeed)</div>
        <div class="tog-desc">ÙŠØ¬Ø¹Ù„ Ø§Ù„ØµÙˆØª ÙŠØ¨Ø¯Ùˆ Ù‚Ø§Ø¯Ù…Ø§Ù‹ Ù…Ù† Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø£Ø³</div>
      </div>
      <label class="tog"><input type="checkbox" id="tCrossfeed" checked><span class="tog-track"></span></label>
    </div>
  </div>

  <!-- 4. Player -->
  <div class="section" style="animation-delay:0.2s">
    <div class="sec-head">
      <div class="sec-icon" style="background:rgba(251,191,36,0.1);color:var(--accent-amber);">
        <i class="fas fa-wave-square"></i>
      </div>
      <div>
        <div class="sec-title">Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„ØªØµÙˆØ±</div>
      </div>
    </div>

    <div class="viz-box">
      <canvas id="vizCanvas"></canvas>
      <div class="viz-tag">NEURAL WAVEFORM</div>
      <div class="viz-mode-tag" id="vizModeTag">INNER VOICE â€” 10 Hz</div>
    </div>

    <div class="transport">
      <button class="btn-round" id="btnPlay" disabled><i class="fas fa-play" id="iPlay"></i></button>
      <button class="btn-round sm" id="btnStop" disabled><i class="fas fa-stop"></i></button>
      <div class="prog-wrap">
        <div class="prog-bg" id="progBar"><div class="prog-fill" id="progFill"></div></div>
        <div class="prog-times"><span id="tCur">0:00</span><span id="tTotal">0:00</span></div>
      </div>
    </div>

    <div class="vol-row">
      <i class="fas fa-volume-high"></i>
      <input type="range" id="sVol" min="0" max="100" step="1" value="80">
      <span class="ctrl-val" id="vVol">80%</span>
    </div>

    <div class="status" id="statusBar">
      <div class="spin" id="statusSpin" style="display:none"></div>
      <i class="fas fa-circle-info" id="statusIco"></i>
      <span id="statusMsg"></span>
    </div>

    <button class="btn-main btn-process" id="btnProcess" disabled>
      <i class="fas fa-bolt"></i>
      <span>ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØµÙˆØª Ø¯Ø§Ø®Ù„ÙŠ</span>
    </button>
    <button class="btn-main btn-dl" id="btnDL" disabled>
      <i class="fas fa-download"></i>
      <span>ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­ÙˆÙ‘Ù„</span>
    </button>
  </div>

  <!-- 5. Info -->
  <div class="section" style="animation-delay:0.25s">
    <div class="sec-head">
      <div class="sec-icon" style="background:rgba(45,212,191,0.1);color:var(--accent-teal);">
        <i class="fas fa-chart-bar"></i>
      </div>
      <div><div class="sec-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div></div>
    </div>
    <div class="info-grid">
      <div class="info-cell"><div class="il">Ø§Ù„ÙˆØ¶Ø¹</div><div class="iv" id="iMode">Ø§Ù„ØµÙˆØª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</div></div>
      <div class="info-cell"><div class="il">Ø§Ù„ØªØ±Ø¯Ø¯</div><div class="iv" id="iFreq">10.0 Hz</div></div>
      <div class="info-cell"><div class="il">Ø¹Ù…Ù‚ Ø§Ù„ØªØ­ÙˆÙŠÙ„</div><div class="iv" id="iDepth">75%</div></div>
      <div class="info-cell"><div class="il">Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ø£Ø°Ù†</div><div class="iv" id="iBin">Ù†Ø¹Ù…</div></div>
    </div>
  </div>

  <!-- 6. How It Works -->
  <div class="section explain" style="animation-delay:0.3s">
    <div class="sec-head">
      <div class="sec-icon" style="background:rgba(251,113,133,0.1);color:var(--accent-rose);">
        <i class="fas fa-lightbulb"></i>
      </div>
      <div><div class="sec-title">ÙƒÙŠÙ ÙŠØ¹Ù…Ù„ Ø§Ù„ØµÙˆØª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØŸ</div></div>
    </div>
    <p><strong>Ù¡. ØªØ£Ø«ÙŠØ± Ø§Ù„Ù‡Ù…Ø³ (Whisper Effect):</strong> ÙŠØ²ÙŠÙ„ Ø§Ù„ØªØ±Ø¯Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø­Ø§Ø¯Ø© ÙˆÙŠÙØ¨Ù‚ÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ 200â€“800 Hz Ø­ÙŠØ« ÙŠØªØ´ÙƒÙ‘Ù„ "ØµÙˆØªÙƒ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ"ØŒ ÙÙŠØ¨Ø¯Ùˆ Ø§Ù„ØµÙˆØª ÙˆÙƒØ£Ù†Ù‡ Ø­Ø¯ÙŠØ« Ù†ÙØ³Ùƒ.</p>
    <p><strong>Ù¢. Ø±Ù†ÙŠÙ† Ø§Ù„Ø¬Ù…Ø¬Ù…Ø© (Bone Resonance):</strong> ÙŠÙØ¹Ø²Ù‘Ø² Ø§Ù„ØªØ±Ø¯Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø© (80â€“300 Hz) Ø§Ù„ØªÙŠ ØªØ´Ø¨Ù‡ Ù…Ø§ ØªØ³Ù…Ø¹Ù‡ Ø¹Ø¨Ø± Ø¹Ø¸Ø§Ù… Ø§Ù„Ø¬Ù…Ø¬Ù…Ø©ØŒ Ù…Ù…Ø§ ÙŠØ®Ù„Ù‚ Ø¥Ø­Ø³Ø§Ø³Ø§Ù‹ Ø¨Ø£Ù† Ø§Ù„ØµÙˆØª ÙŠØ£ØªÙŠ Ù…Ù† Ø¯Ø§Ø®Ù„ Ø±Ø£Ø³Ùƒ.</p>
    <p><span class="highlight">Ù£. Ø§Ù„Ù…Ø²Ø¬ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ (Crossfeed):</span> ÙŠÙ…Ø²Ø¬ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„ØµÙˆØªÙŠØ© Ø¨Ø·Ø±ÙŠÙ‚Ø© ØªØ¬Ø¹Ù„ Ø§Ù„ØµÙˆØª ÙŠØ¨Ø¯Ùˆ Ù…ØªÙ…Ø±ÙƒØ²Ø§Ù‹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ù…Ø§Øº Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø°Ù†ÙŠÙ†.</p>
    <p><strong>Ù¤. Ø§Ù„Ù†ØºÙ…Ø§Øª Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ© (Binaural Beats):</strong> ØªØ±Ø¯Ø¯ Ù…Ø®ØªÙ„Ù Ù„ÙƒÙ„ Ø£Ø°Ù† â†’ ÙŠÙÙ†ØªØ¬ Ù†ØºÙ…Ø© "ÙˆÙ‡Ù…ÙŠØ©" ÙŠØµÙ†Ø¹Ù‡Ø§ Ø§Ù„Ø¯Ù…Ø§Øº Ù†ÙØ³Ù‡ ÙˆÙŠØ³Ù…Ø¹Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©.</p>
    <p><strong>Ù¥. Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ:</strong> ÙŠÙØ³ÙˆÙ‘ÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª Ù„ÙŠØµØ¨Ø­ Ø«Ø§Ø¨ØªØ§Ù‹ ÙˆÙ‡Ø§Ø¯Ø¦Ø§Ù‹ ÙƒÙ…Ø§ ÙŠØ¨Ø¯Ùˆ Ø§Ù„ØµÙˆØª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ ÙÙŠ Ø°Ù‡Ù†Ùƒ.</p>
    <div class="note">
      <i class="fas fa-headphones"></i>
      <strong>Ù…Ù‡Ù…:</strong> Ø§Ø³ØªØ®Ø¯Ù… Ø³Ù…Ø§Ø¹Ø§Øª Ø§Ù„Ø±Ø£Ø³ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©. Ø§Ù„Ù†ØºÙ…Ø§Øª Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ù…Ø²Ø¬ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ù„Ø§ ÙŠØ¹Ù…Ù„Ø§Ù† Ø¨Ø¯ÙˆÙ† Ø³Ù…Ø§Ø¹Ø§Øª. Ø§Ø¬Ù„Ø³ ÙÙŠ Ù…ÙƒØ§Ù† Ù‡Ø§Ø¯Ø¦ ÙˆØ£ØºÙ…Ø¶ Ø¹ÙŠÙ†ÙŠÙƒ Ù„Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø©.
    </div>
  </div>

  <div class="footer">NEUROSOUND â€” INNER VOICE TECHNOLOGY</div>
</div>

<script>
/* ============ DARK MODE ============ */
(function(){
  function applyTheme(dark) {
    if (dark) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
  }
  if (window.matchMedia) {
    applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches);
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e){ applyTheme(e.matches); });
  } else {
    applyTheme(true);
  }
})();

/* ============ STATE ============ */
var S = {
  file: null,
  rawBuffer: null,
  processed: null,
  blob: null,
  ctx: null,
  src: null,
  gain: null,
  analyser: null,
  playing: false,
  startT: 0,
  pauseOff: 0,
  animId: null,
  mode: 'inner'
};

/* ============ DOM ============ */
var $ = function(id){ return document.getElementById(id); };
var uploadZone = $('uploadZone'), audioInput = $('audioInput'),
    uploadPh = $('uploadPh'), fileRow = $('fileRow'),
    fName = $('fName'), fMeta = $('fMeta'), btnRemove = $('btnRemove');
var modesGrid = $('modesGrid'), presetsEl = $('presets');
var sFreq = $('sFreq'), vFreq = $('vFreq'),
    sDepth = $('sDepth'), vDepth = $('vDepth'),
    sWhisper = $('sWhisper'), vWhisper = $('vWhisper'),
    sResonance = $('sResonance'), vResonance = $('vResonance'),
    sSublevel = $('sSublevel'), vSublevel = $('vSublevel');
var tBinaural = $('tBinaural'), tWhisper = $('tWhisper'),
    tResonance = $('tResonance'), tCompress = $('tCompress'), tCrossfeed = $('tCrossfeed');
var btnPlay = $('btnPlay'), btnStop = $('btnStop'), iPlay = $('iPlay');
var progBar = $('progBar'), progFill = $('progFill'), tCur = $('tCur'), tTotal = $('tTotal');
var sVol = $('sVol'), vVol = $('vVol');
var statusBar = $('statusBar'), statusSpin = $('statusSpin'), statusIco = $('statusIco'), statusMsg = $('statusMsg');
var btnProcess = $('btnProcess'), btnDL = $('btnDL');
var vizCanvas = $('vizCanvas'), vizCtx = vizCanvas.getContext('2d'), vizModeTag = $('vizModeTag');
var iMode = $('iMode'), iFreq = $('iFreq'), iDepth = $('iDepth'), iBin = $('iBin');

var modeNames = { inner:'Ø§Ù„ØµÙˆØª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ', subliminal:'ØªØ­Øª Ø§Ù„ÙˆØ¹ÙŠ', meditate:'ØªØ£Ù…Ù„ Ø¹Ù…ÙŠÙ‚', focus:'ØªØ­ÙÙŠØ² Ø°Ù‡Ù†ÙŠ' };
var modeTags  = { inner:'INNER VOICE', subliminal:'SUBLIMINAL', meditate:'DEEP MEDITATION', focus:'NEURO FOCUS' };
var modeColors = {
  inner:  {r:110,g:231,b:183},
  subliminal:{r:167,g:139,b:250},
  meditate:{r:56,g:189,b:248},
  focus:  {r:251,g:191,b:36}
};

/* ============ UTILS ============ */
function fmtTime(s){ var m=Math.floor(s/60),ss=Math.floor(s%60); return m+':'+(ss<10?'0':'')+ss; }
function fmtSize(b){ return b<1048576?(b/1024).toFixed(1)+' KB':(b/1048576).toFixed(1)+' MB'; }

function showSt(type, msg){
  statusBar.className = 'status on ' + type;
  statusMsg.textContent = msg;
  if(type==='working'){ statusSpin.style.display='block'; statusIco.style.display='none'; }
  else { statusSpin.style.display='none'; statusIco.style.display=''; statusIco.className=type==='done'?'fas fa-circle-check':'fas fa-circle-xmark'; }
}
function hideSt(){ statusBar.className='status'; }
function getCtx(){ if(!S.ctx) S.ctx = new (window.AudioContext||window.webkitAudioContext)(); return S.ctx; }

/* ============ UPLOAD ============ */
uploadZone.addEventListener('click', function(e){ if(e.target===btnRemove||btnRemove.contains(e.target)) return; audioInput.click(); });
uploadZone.addEventListener('dragover', function(e){ e.preventDefault(); uploadZone.classList.add('hovering'); });
uploadZone.addEventListener('dragleave', function(){ uploadZone.classList.remove('hovering'); });
uploadZone.addEventListener('drop', function(e){ e.preventDefault(); uploadZone.classList.remove('hovering'); if(e.dataTransfer.files.length && e.dataTransfer.files[0].type.startsWith('audio/')) loadFile(e.dataTransfer.files[0]); });
audioInput.addEventListener('change', function(){ if(audioInput.files.length) loadFile(audioInput.files[0]); });
btnRemove.addEventListener('click', function(e){ e.stopPropagation(); resetAll(); });

function loadFile(f){
  if(f.size>50*1048576){ showSt('fail','Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯'); return; }
  S.file = f;
  fName.textContent = f.name;
  fMeta.textContent = fmtSize(f.size)+' â€¢ '+f.type.split('/')[1].toUpperCase();
  uploadPh.style.display='none'; fileRow.style.display='flex'; uploadZone.classList.add('loaded');
  btnProcess.disabled=false; hideSt();
  var r=new FileReader();
  r.onload=function(e){
    getCtx().decodeAudioData(e.target.result).then(function(buf){
      S.rawBuffer=buf; tTotal.textContent=fmtTime(buf.duration);
      showSt('done','Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØµÙˆØª Ø¯Ø§Ø®Ù„ÙŠ');
    }).catch(function(){ showSt('fail','ØªØ¹Ø°Ù‘Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'); btnProcess.disabled=true; });
  };
  r.readAsArrayBuffer(f);
}

function resetAll(){
  stopAudio();
  S.file=null; S.rawBuffer=null; S.processed=null; S.blob=null;
  uploadPh.style.display=''; fileRow.style.display='none'; uploadZone.classList.remove('loaded');
  audioInput.value='';
  btnProcess.disabled=true; btnPlay.disabled=true; btnStop.disabled=true; btnDL.disabled=true;
  progFill.style.width='0%'; tCur.textContent='0:00'; tTotal.textContent='0:00';
  hideSt();
}

/* ============ MODE SELECT ============ */
modesGrid.addEventListener('click', function(e){
  var card = e.target.closest('.mode-card');
  if(!card) return;
  document.querySelectorAll('.mode-card').forEach(function(c){ c.classList.remove('active'); });
  card.classList.add('active');
  S.mode = card.dataset.mode;
  applyModeDefaults();
  updateInfo();
});

presetsEl.addEventListener('click', function(e){
  var chip = e.target.closest('.preset-chip');
  if(!chip) return;
  document.querySelectorAll('.preset-chip').forEach(function(c){ c.classList.remove('active'); });
  chip.classList.add('active');
  applyPreset(chip.dataset.preset);
});

function applyModeDefaults(){
  var m = S.mode;
  if(m==='inner')     { sFreq.value=10; sDepth.value=75; sWhisper.value=60; sResonance.value=50; sSublevel.value=40; tBinaural.checked=true; tWhisper.checked=true; tResonance.checked=true; tCompress.checked=true; tCrossfeed.checked=true; }
  if(m==='subliminal'){ sFreq.value=6;  sDepth.value=90; sWhisper.value=80; sResonance.value=60; sSublevel.value=20; tBinaural.checked=true; tWhisper.checked=true; tResonance.checked=true; tCompress.checked=true; tCrossfeed.checked=true; }
  if(m==='meditate')  { sFreq.value=4;  sDepth.value=70; sWhisper.value=50; sResonance.value=70; sSublevel.value=35; tBinaural.checked=true; tWhisper.checked=true; tResonance.checked=true; tCompress.checked=true; tCrossfeed.checked=true; }
  if(m==='focus')     { sFreq.value=40; sDepth.value=60; sWhisper.value=30; sResonance.value=40; sSublevel.value=50; tBinaural.checked=true; tWhisper.checked=false; tResonance.checked=true; tCompress.checked=true; tCrossfeed.checked=true; }
  syncSliderDisplays();
}

function applyPreset(p){
  if(p==='balanced') { sDepth.value=75; sWhisper.value=60; sResonance.value=50; sSublevel.value=40; }
  if(p==='deep')     { sDepth.value=95; sWhisper.value=85; sResonance.value=75; sSublevel.value=25; }
  if(p==='gentle')   { sDepth.value=50; sWhisper.value=40; sResonance.value=35; sSublevel.value=55; }
  if(p==='intense')  { sDepth.value=100;sWhisper.value=90; sResonance.value=80; sSublevel.value=15; }
  syncSliderDisplays();
}

function syncSliderDisplays(){
  vFreq.textContent = parseFloat(sFreq.value).toFixed(1)+' Hz';
  vDepth.textContent = sDepth.value+'%';
  vWhisper.textContent = sWhisper.value+'%';
  vResonance.textContent = sResonance.value+'%';
  vSublevel.textContent = sSublevel.value+'%';
  updateInfo();
}

/* Slider events */
[sFreq,sDepth,sWhisper,sResonance,sSublevel,sVol].forEach(function(sl){
  sl.addEventListener('input', syncSliderDisplays);
});
sVol.addEventListener('input', function(){
  vVol.textContent = sVol.value+'%';
  if(S.gain) S.gain.gain.value = sVol.value/100;
});

function updateInfo(){
  iMode.textContent = modeNames[S.mode]||S.mode;
  iFreq.textContent = parseFloat(sFreq.value).toFixed(1)+' Hz';
  iDepth.textContent = sDepth.value+'%';
  iBin.textContent = tBinaural.checked?'Ù†Ø¹Ù…':'Ù„Ø§';
  vizModeTag.textContent = (modeTags[S.mode]||'')+ ' â€” ' + parseFloat(sFreq.value).toFixed(1) + ' Hz';
}
updateInfo();

/* ============ AUDIO PROCESSING ENGINE ============ */
btnProcess.addEventListener('click', function(){
  if(!S.rawBuffer) return;
  processAudio();
});

function processAudio(){
  stopAudio();
  showSt('working','Ø¬Ø§Ø±Ù ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¥Ù„Ù‰ ØªØ¬Ø±Ø¨Ø© Ø¯Ø§Ø®Ù„ÙŠØ©...');
  btnProcess.disabled=true; btnPlay.disabled=true; btnDL.disabled=true;

  setTimeout(function(){
    try {
      var freq      = parseFloat(sFreq.value);
      var depth     = parseInt(sDepth.value)/100;
      var whisperAmt= parseInt(sWhisper.value)/100;
      var resAmt    = parseInt(sResonance.value)/100;
      var subLevel  = parseInt(sSublevel.value)/100;
      var useBin    = tBinaural.checked;
      var useWhisper= tWhisper.checked;
      var useRes    = tResonance.checked;
      var useComp   = tCompress.checked;
      var useCross  = tCrossfeed.checked;

      var raw = S.rawBuffer;
      var sr  = raw.sampleRate;
      var len = raw.length;
      var outCh = 2; // always stereo for binaural/crossfeed

      var buf = new (window.OfflineAudioContext||window.webkitOfflineAudioContext)(outCh, len, sr).createBuffer(outCh, len, sr);

      // Get mono mix of input
      var mono = new Float32Array(len);
      for(var c=0; c<raw.numberOfChannels; c++){
        var ch = raw.getChannelData(c);
        for(var i=0;i<len;i++) mono[i] += ch[i];
      }
      var chCount = raw.numberOfChannels;
      for(var i2=0;i2<len;i2++) mono[i2] /= chCount;

      // ---- Stage 1: Whisper / inner voice filter ----
      // Simulate internal voice by heavy low-pass + resonant bandpass around 200-800Hz
      var whispered = new Float32Array(len);
      if(useWhisper && whisperAmt > 0){
        // Simple IIR low-pass at ~900Hz and resonance boost at ~400Hz
        var lpCutoff = 900 - whisperAmt * 400; // 500-900 Hz
        var rc = 1.0/(2*Math.PI*lpCutoff);
        var dt = 1.0/sr;
        var lpAlpha = dt/(rc+dt);
        var prev = 0;
        for(var w=0;w<len;w++){
          prev = prev + lpAlpha*(mono[w]-prev);
          whispered[w] = prev;
        }
        // Bandpass resonance around 350Hz for "inner voice" character
        var bpFreq = 350;
        var bpQ = 2 + whisperAmt * 4;
        var bpW0 = 2*Math.PI*bpFreq/sr;
        var bpAlp = Math.sin(bpW0)/(2*bpQ);
        var b0=bpAlp, b1=0, b2=-bpAlp;
        var a0=1+bpAlp, a1=-2*Math.cos(bpW0), a2=1-bpAlp;
        b0/=a0; b1/=a0; b2/=a0; a1/=a0; a2/=a0;
        var bx1=0,bx2=0,by1=0,by2=0;
        var bpOut = new Float32Array(len);
        for(var bp=0;bp<len;bp++){
          var xn = whispered[bp];
          bpOut[bp] = b0*xn + b1*bx1 + b2*bx2 - a1*by1 - a2*by2;
          bx2=bx1; bx1=xn; by2=by1; by1=bpOut[bp];
        }
        // Blend whispered + bandpass resonance
        var wMix = whisperAmt;
        for(var ww=0;ww<len;ww++){
          whispered[ww] = mono[ww]*(1-wMix) + (whispered[ww]*0.6 + bpOut[ww]*0.4)*wMix;
        }
      } else {
        for(var cp=0;cp<len;cp++) whispered[cp]=mono[cp];
      }

      // ---- Stage 2: Skull bone resonance ----
      var resonated = new Float32Array(len);
      if(useRes && resAmt > 0){
        // Boost low frequencies 80-300Hz (bone conduction simulation)
        var rFreq = 150;
        var rQ = 1.5 + resAmt * 3;
        var rW0 = 2*Math.PI*rFreq/sr;
        var rAlp = Math.sin(rW0)/(2*rQ);
        var A = Math.pow(10, (resAmt*12)/40); // boost up to 12dB
        var rb0 = 1+rAlp*A, rb1 = -2*Math.cos(rW0), rb2 = 1-rAlp*A;
        var ra0 = 1+rAlp/A, ra1 = -2*Math.cos(rW0), ra2 = 1-rAlp/A;
        rb0/=ra0; rb1/=ra0; rb2/=ra0; ra1/=ra0; ra2/=ra0;
        var rx1=0,rx2=0,ry1=0,ry2=0;
        for(var rr=0;rr<len;rr++){
          var rxn = whispered[rr];
          resonated[rr] = rb0*rxn + rb1*rx1 + rb2*rx2 - ra1*ry1 - ra2*ry2;
          rx2=rx1; rx1=rxn; ry2=ry1; ry1=resonated[rr];
        }
        // Add a subtle reverb-like delay simulating skull cavity resonance
        var delayMs = 8 + resAmt * 12; // 8-20ms
        var delaySamples = Math.round(sr * delayMs / 1000);
        var feedback = 0.2 + resAmt * 0.3;
        for(var rd=delaySamples;rd<len;rd++){
          resonated[rd] += resonated[rd-delaySamples] * feedback;
        }
      } else {
        for(var cr=0;cr<len;cr++) resonated[cr]=whispered[cr];
      }

      // ---- Stage 3: Dynamic compression ----
      var compressed = new Float32Array(len);
      if(useComp){
        var envThresh = 0.15;
        var ratio = 4;
        var atk = Math.exp(-1/(sr*0.005));
        var rel = Math.exp(-1/(sr*0.1));
        var env = 0;
        for(var dc=0;dc<len;dc++){
          var absVal = Math.abs(resonated[dc]);
          if(absVal>env) env = atk*env + (1-atk)*absVal;
          else env = rel*env + (1-rel)*absVal;
          var gainReduction = 1;
          if(env>envThresh){
            var dbOver = 20*Math.log10(env/envThresh);
            var dbReduced = dbOver * (1-1/ratio);
            gainReduction = Math.pow(10, -dbReduced/20);
          }
          compressed[dc] = resonated[dc] * gainReduction;
        }
        // Normalize
        var peak = 0;
        for(var np=0;np<len;np++) if(Math.abs(compressed[np])>peak) peak=Math.abs(compressed[np]);
        if(peak>0.001){
          var norm = 0.85/peak;
          for(var nn=0;nn<len;nn++) compressed[nn]*=norm;
        }
      } else {
        for(var cc2=0;cc2<len;cc2++) compressed[cc2]=resonated[cc2];
      }

      // ---- Stage 4: Amplitude modulation (brainwave entrainment) ----
      var modulated = new Float32Array(len);
      for(var am=0;am<len;am++){
        var t=am/sr;
        var amFactor = 1 - depth + depth*(0.5+0.5*Math.sin(2*Math.PI*freq*t));
        modulated[am] = compressed[am] * amFactor;
      }

      // ---- Stage 5: Sub-level volume reduction (subliminal) ----
      for(var sv=0;sv<len;sv++){
        modulated[sv] *= subLevel;
      }

      // ---- Stage 6: Binaural beats + crossfeed â†’ stereo output ----
      var leftOut  = buf.getChannelData(0);
      var rightOut = buf.getChannelData(1);

      var halfDiff = freq/2;
      var carrierF = 200;
      var binAmp = useBin ? 0.06*depth : 0;

      for(var out=0;out<len;out++){
        var t2 = out/sr;
        var sample = modulated[out];

        if(useCross){
          // Crossfeed: blend L/R strongly to center the sound in the head
          // With mono source, add subtle ITD (interaural time difference) simulation
          var itdSamples = 6; // ~0.15ms at 44.1kHz â‰ˆ minimal ITD
          var lSamp = sample;
          var rSamp = (out >= itdSamples) ? modulated[out-itdSamples]*0.95 : sample*0.95;
          // Mix towards center
          var crossAmt = 0.85;
          leftOut[out]  = lSamp*(1-crossAmt*0.5) + rSamp*(crossAmt*0.5);
          rightOut[out] = rSamp*(1-crossAmt*0.5) + lSamp*(crossAmt*0.5);
        } else {
          leftOut[out] = sample;
          rightOut[out] = sample;
        }

        // Add binaural tones
        if(useBin){
          leftOut[out]  += binAmp * Math.sin(2*Math.PI*(carrierF-halfDiff)*t2);
          rightOut[out] += binAmp * Math.sin(2*Math.PI*(carrierF+halfDiff)*t2);
        }

        // Isochronic pulse
        var pulse = Math.sin(2*Math.PI*freq*t2) > 0 ? 1 : 0;
        var isoAmp = 0.02 * depth;
        var isoTone = isoAmp * pulse * Math.sin(2*Math.PI*180*t2);
        leftOut[out]  += isoTone;
        rightOut[out] += isoTone;
      }

      // Soft clip
      for(var sc=0;sc<len;sc++){
        leftOut[sc]  = Math.tanh(leftOut[sc]);
        rightOut[sc] = Math.tanh(rightOut[sc]);
      }

      S.processed = buf;
      S.blob = encodeWAV(buf);

      showSt('done','ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„! Ø§Ù„ØµÙˆØª Ø¬Ø§Ù‡Ø² ÙƒØªØ¬Ø±Ø¨Ø© Ø¯Ø§Ø®Ù„ÙŠØ©');
      btnProcess.disabled=false; btnPlay.disabled=false; btnStop.disabled=false; btnDL.disabled=false;
      updateInfo();

    } catch(err){
      showSt('fail','Ø®Ø·Ø£: '+err.message);
      btnProcess.disabled=false;
    }
  }, 80);
}

/* ============ WAV ENCODE ============ */
function encodeWAV(buffer){
  var nCh=buffer.numberOfChannels, sr=buffer.sampleRate, len=buffer.length;
  var bps=2, dataLen=len*nCh*bps, total=44+dataLen;
  var ab=new ArrayBuffer(total), v=new DataView(ab);
  function ws(o,s){for(var i=0;i<s.length;i++) v.setUint8(o+i,s.charCodeAt(i));}
  ws(0,'RIFF'); v.setUint32(4,total-8,true); ws(8,'WAVE'); ws(12,'fmt ');
  v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,nCh,true);
  v.setUint32(24,sr,true); v.setUint32(28,sr*nCh*bps,true);
  v.setUint16(32,nCh*bps,true); v.setUint16(34,16,true);
  ws(36,'data'); v.setUint32(40,dataLen,true);
  var chs=[]; for(var c=0;c<nCh;c++) chs.push(buffer.getChannelData(c));
  var off=44;
  for(var i=0;i<len;i++){
    for(var ch=0;ch<nCh;ch++){
      var s=Math.max(-1,Math.min(1,chs[ch][i]));
      v.setInt16(off, s<0?s*32768:s*32767, true);
      off+=2;
    }
  }
  return new Blob([ab],{type:'audio/wav'});
}

/* ============ PLAYBACK ============ */
btnPlay.addEventListener('click', function(){ if(S.playing) pauseAudio(); else playAudio(); });
btnStop.addEventListener('click', stopAudio);
progBar.addEventListener('click', function(e){
  if(!S.processed) return;
  var r=progBar.getBoundingClientRect();
  var ratio=Math.max(0,Math.min(1,(e.clientX-r.left)/r.width));
  var seekT = ratio*S.processed.duration;
  if(S.playing){ stopAudio(); S.pauseOff=seekT; playAudio(); }
  else { S.pauseOff=seekT; tCur.textContent=fmtTime(seekT); progFill.style.width=(ratio*100)+'%'; }
});

function playAudio(){
  if(!S.processed) return;
  var ctx=getCtx();
  if(ctx.state==='suspended') ctx.resume();
  S.src = ctx.createBufferSource();
  S.src.buffer = S.processed;
  S.gain = ctx.createGain();
  S.gain.gain.value = sVol.value/100;
  S.analyser = ctx.createAnalyser();
  S.analyser.fftSize = 2048;
  S.src.connect(S.gain); S.gain.connect(S.analyser); S.analyser.connect(ctx.destination);
  S.src.onended = function(){ if(S.playing) stopAudio(); };
  S.src.start(0, S.pauseOff);
  S.startT = ctx.currentTime - S.pauseOff;
  S.playing = true;
  iPlay.className='fas fa-pause'; btnPlay.classList.add('on');
  tickProgress();
}

function pauseAudio(){
  if(!S.playing) return;
  S.pauseOff = getCtx().currentTime - S.startT;
  S.src.onended=null;
  S.src.stop(); S.src.disconnect();
  S.playing=false;
  iPlay.className='fas fa-play'; btnPlay.classList.remove('on');
  if(S.animId){ cancelAnimationFrame(S.animId); S.animId=null; }
}

function stopAudio(){
  if(S.src){ S.src.onended=null; try{S.src.stop();}catch(e){} try{S.src.disconnect();}catch(e){} S.src=null; }
  if(S.gain){ try{S.gain.disconnect();}catch(e){} S.gain=null; }
  if(S.analyser){ try{S.analyser.disconnect();}catch(e){} }
  S.playing=false; S.pauseOff=0; S.startT=0;
  iPlay.className='fas fa-play'; btnPlay.classList.remove('on');
  progFill.style.width='0%'; tCur.textContent='0:00';
  if(S.animId){ cancelAnimationFrame(S.animId); S.animId=null; }
}

function tickProgress(){
  if(!S.playing||!S.processed) return;
  var el = getCtx().currentTime - S.startT;
  var dur = S.processed.duration;
  if(el>dur){ stopAudio(); return; }
  tCur.textContent = fmtTime(el);
  progFill.style.width = (el/dur*100)+'%';
  drawViz();
  S.animId = requestAnimationFrame(tickProgress);
}

/* ============ VISUALIZER ============ */
function resizeViz(){
  var r=vizCanvas.parentElement.getBoundingClientRect();
  var dpr = window.devicePixelRatio||1;
  vizCanvas.width = r.width*dpr; vizCanvas.height = r.height*dpr;
  vizCtx.setTransform(dpr,0,0,dpr,0,0);
}
resizeViz(); window.addEventListener('resize', resizeViz);

function drawViz(){
  if(!S.analyser) return;
  var w=vizCanvas.width/(window.devicePixelRatio||1), h=vizCanvas.height/(window.devicePixelRatio||1);
  vizCtx.clearRect(0,0,w,h);
  var col = modeColors[S.mode]||modeColors.inner;

  // Time domain
  var td = new Uint8Array(S.analyser.frequencyBinCount);
  S.analyser.getByteTimeDomainData(td);
  var sw = w/td.length;

  // Glow
  vizCtx.beginPath();
  vizCtx.strokeStyle='rgba('+col.r+','+col.g+','+col.b+',0.12)';
  vizCtx.lineWidth=7;
  for(var i=0;i<td.length;i++){
    var y=(td[i]/128)*h/2;
    if(i===0) vizCtx.moveTo(i*sw,y); else vizCtx.lineTo(i*sw,y);
  }
  vizCtx.stroke();

  // Main
  vizCtx.beginPath();
  vizCtx.strokeStyle='rgb('+col.r+','+col.g+','+col.b+')';
  vizCtx.lineWidth=2;
  vizCtx.shadowColor='rgb('+col.r+','+col.g+','+col.b+')';
  vizCtx.shadowBlur=10;
  for(var j=0;j<td.length;j++){
    var yy=(td[j]/128)*h/2;
    if(j===0) vizCtx.moveTo(j*sw,yy); else vizCtx.lineTo(j*sw,yy);
  }
  vizCtx.stroke();
  vizCtx.shadowBlur=0;

  // Frequency bars
  var fd = new Uint8Array(S.analyser.frequencyBinCount);
  S.analyser.getByteFrequencyData(fd);
  var bars=50, bw=w/bars, step=Math.floor(fd.length/bars);
  for(var b=0;b<bars;b++){
    var val=fd[b*step]/255;
    var bh=val*h*0.28;
    vizCtx.fillStyle='rgba('+col.r+','+col.g+','+col.b+','+(0.08+val*0.25)+')';
    vizCtx.fillRect(b*bw,h-bh,bw-1,bh);
  }
}

// Idle animation
function drawIdle(){
  if(S.playing) { requestAnimationFrame(drawIdle); return; }
  var w=vizCanvas.width/(window.devicePixelRatio||1), h=vizCanvas.height/(window.devicePixelRatio||1);
  vizCtx.clearRect(0,0,w,h);
  var col = modeColors[S.mode]||modeColors.inner;
  var t=Date.now()/1000;
  var f=parseFloat(sFreq.value);
  vizCtx.beginPath();
  vizCtx.strokeStyle='rgba('+col.r+','+col.g+','+col.b+',0.25)';
  vizCtx.lineWidth=1.5;
  for(var x=0;x<w;x++){
    var p=x/w;
    var y=h/2 + Math.sin(p*f*0.5+t*2)*18 + Math.sin(p*f*1.3+t*2.7)*7;
    if(x===0) vizCtx.moveTo(x,y); else vizCtx.lineTo(x,y);
  }
  vizCtx.stroke();
  // Second wave (ghost)
  vizCtx.beginPath();
  vizCtx.strokeStyle='rgba('+col.r+','+col.g+','+col.b+',0.08)';
  vizCtx.lineWidth=3;
  for(var x2=0;x2<w;x2++){
    var p2=x2/w;
    var y2=h/2 + Math.sin(p2*f*0.5+t*2+0.3)*22 + Math.cos(p2*f*0.8+t*1.5)*10;
    if(x2===0) vizCtx.moveTo(x2,y2); else vizCtx.lineTo(x2,y2);
  }
  vizCtx.stroke();
  // Center line
  vizCtx.beginPath();
  vizCtx.strokeStyle='rgba('+col.r+','+col.g+','+col.b+',0.04)';
  vizCtx.lineWidth=1;
  vizCtx.moveTo(0,h/2); vizCtx.lineTo(w,h/2);
  vizCtx.stroke();
  requestAnimationFrame(drawIdle);
}
drawIdle();

/* ============ DOWNLOAD ============ */
btnDL.addEventListener('click', function(){
  if(!S.blob) return;
  var url=URL.createObjectURL(S.blob);
  var a=document.createElement('a');
  a.href=url;
  var orig=S.file?S.file.name.replace(/\.[^/.]+$/,''):'audio';
  a.download=orig+'_inner_voice_'+S.mode+'.wav';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

/* ============ INIT ============ */
syncSliderDisplays();
</script>
</body>
</html>
